---
title: "Linked selection and filtering using crosstalk"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Linked selection and filtering using crosstalk}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

The `langevitour` development version now supports receiving selections and filters from other htmlwidgets that support the [crosstalk](https://rstudio.github.io/crosstalk/) package. It will also contribute to filtering based on which groups are checked.

Use the `link=` argument to `langevitour` to specify a `SharedData` object to watch for selections and filters.

**Note:** As at 2022-09-25 you must install the development version of `plotly` for plotly widgets in this page to work.

```{r eval=FALSE}
remotes::install_github("pfh/langevitour")
remotes::install_github("plotly/plotly.R")
```

<br><br><br>

# Linked selections

```{r message=FALSE,warning=FALSE}
library(langevitour)
library(crosstalk)
library(ggplot2)
library(GGally)
library(plotly)
library(DT)
library(palmerpenguins)

completePenguins <- na.omit(penguins)
scale <- apply(completePenguins[,3:6], 2, sd)*4
colors <- scales::hue_pal()(3)

# crosstalk object that allows widgets to be linked
shared <- SharedData$new(completePenguins)

# Create a plotly widget showing all pairs of variables
ggpairsWidget <- ggpairs(shared, aes(color=species, text=""), columns=3:6) |>
    ggplotly(tooltip="text", width=700, height=700) |> 
    style(unselected=list(marker=list(opacity=1))) |> # Don't double-fade unselected points
    highlight(on="plotly_selected", off="plotly_deselect")

# Create a langevitour widget that listens for selections and filters
langevitourWidget <- langevitour(
    completePenguins[,3:6], 
    completePenguins$species, 
    link=shared,                   #<--- the important bit
    levelColors=colors, 
    scale=scale, 
    pointSize=2,
    width=700, height=700)

# Create a table widget
datatableWidget <- datatable(
    shared,
    extensions='Buttons', 
    options=list(dom='Bfrtip',buttons=c('copy','csv','excel')))
```

```{r eval=FALSE}
bscols(ggpairsWidget, langevitourWidget)
datatableWidget
```

::: {style="width: 1400px"}
:::: {style="font-size: 200%"}
Drag on the pairs plot or click rows in the table to select points.
::::
```{r echo=FALSE}
bscols(ggpairsWidget, langevitourWidget)
datatableWidget
```
:::

<br><br><br>

# Linked filters

Filters hide points completely. The view of the data chosen by a `langevitour` guide will adapt to this.

I want to demonstrate this with an independent set of widgets, so I make a new SharedData object.

```{r}
shared2 <- SharedData$new(completePenguins)

# Create some filters
filter2a <- filter_slider(
    "filter2a", "Filter body mass (g)", shared2, ~body_mass_g)
filter2b <- filter_checkbox(
    "filter2b", "Filter sex", shared2, ~sex)

# Create a langevitour widget that listens for selections and filters
langevitourWidget2 <- langevitour(
    completePenguins[,3:6], 
    completePenguins$species, 
    link=shared2,
    levelColors=colors, 
    scale=scale, 
    pointSize=2,
    state='{"guideType":"pca"}')

# Create a plotly widget
plot2 <- ggplot(shared2, aes(x=sex, y=body_mass_g, color=species)) + 
    geom_jitter(height=0) + 
    guides(color="none")
plotWidget2 <- ggplotly(plot2, height=600) |> 
    style(unselected=list(marker=list(opacity=1))) |>  # Don't double-fade unselected points
    highlight(on="plotly_selected", off="plotly_deselect")
```

```{r eval=FALSE}
bscols(filter2a, filter2b)
bscols(plotWidget2, langevitourWidget2)
```

```{r echo=FALSE}
bscols(filter2a, filter2b)
bscols(plotWidget2, langevitourWidget2)
```
